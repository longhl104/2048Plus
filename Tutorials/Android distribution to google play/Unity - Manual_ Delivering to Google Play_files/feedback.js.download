
/****************************************
Feedback

Note: this file is not automatically published to the server. If you make changes here, this file needs to be manually updated on the server.

v3
****************************************/

function InitialiseStarRating()
{
    try {
        // initialise star rating system:
        var ratecontent = document.querySelector('#feedback-ratecontent'); // target element
        var currentRating = 0; // initial rating
        var maxRating= 5; // max rating


        // callback to run after setting the rating
        var callback = function(rating) {
            document.getElementById('feedback-ratingThanks').style.display = '';
            document.getElementById('feedback-ratecontent').style.display = 'none';
            document.getElementById('feedback-rating').style.display = 'none';
            SendFeedbackEvent("rating",rating);
        };

        // rating instance
        var myRating = rating(ratecontent, currentRating, maxRating, callback);
    } catch (err) {
        debuglog("star rating initialise error: "+err);
    }
}

var debug = 0;
var gotPageDetails = false;

function GetPageDetails()
{
	if (gotPageDetails) 
	{
		// already done
		return;
	}
		
	
    window.pagearea = "unknown";
    window.pagetype = "unknown";
    window.pagetags = "";
    window.trimmedPageName = "";
    window.pageversion = "default";

    var pageName = window.location.href;
	
    if (pageName.includes("?debug"))
    {
        debug = true;
        debuglog("feedback system debug mode: on");
    }
    
    // remove named anchor if present:
    pageName = pageName.replace(/#.*/,"");
    
    // remove domain part of URL from start of string, including slash after domain
    pageName = pageName.replace(/^.*?\.unity3d\.com\//,"");
    pageName = pageName.replace(/^.*?\.unity\.com\//,"");
    
    // remove version part of URL if not default version, which should now be at start of string if present.
    // identified by any string of characters containing only: digits/period, followed by slash
    if (pageName.match(/^[0-9.]+\//))
    {
        window.pageversion = pageName.substring(0, pageName.indexOf('/'));
        pageName = pageName.replace(/^[0-9.]+\//,"");
    }
    
    // for classic docs (not mizu), an explicit version in the URL is always
    // followed by /Documentation/ which we also remove
    pageName = pageName.replace(/^Documentation\//,"");
    
    // remove trailing ".html" extension
    pageName = pageName.replace(/\.html$/,"");
    
    pageIsPackage = false;
    if (pageName.startsWith("Manual/") || pageName.includes("/Manual/"))
    {
        // trim everything up to the word Manual
        pageName = pageName.replace(/^.*?Manual\//,"Manual/");
        
        debuglog("is manual");
        window.pagetype = "manual";

        // check whether the page file name matches a package name
        var pageAsPackage = pageName.replace("Manual/","Packages/");

       // if it matches, it's an autogenerated package landing page
       // overwrite pageName so that when we perform the lookup, we get the details for that package
        if (feedbackAreas[pageAsPackage] != null)
        {
            pageName = pageAsPackage;
            pageIsPackage = true;
            window.pagetype = "package";
            pageName = pageName.replace(/^Packages\//,"");
            debuglog("but treating as package");
        }
    }
    else if (pageName.startsWith("Packages/"))
    {
        
        // trim everything up to the word Packages
        pageName = pageName.replace(/^.*?Packages\//,"Packages/");

        
        debuglog("is package");
        pageIsPackage = true;
        window.pagetype = "package";
    }
    else if (pageName.startsWith("ScriptReference/"))
    {
        // trim everything up to the word ScriptReference
        pageName = pageName.replace(/^.*?ScriptReference\//,"ScriptReference/");
        
        debuglog("is scriptref");
        window.pagetype = "scriptref";
    } else {
        debuglog("Unknown page type! Could not determine from parsing URL");
        window.pagetype = "unknown";  
    }
    
    window.trimmedPageName = pageName;
    debuglog("Trimmed page name: " + window.trimmedPageName);
    debuglog("window.pagetype == " + window.pagetype);
    
	// search feedbackAreas data for page area and tags
    debuglog("Searching for match for " + window.trimmedPageName)
    var longestMatchLength = 0;
    for (var key in feedbackAreas)  // iterate over values from feedback-areas.js
    {
        var keyIsPackage = false;
        if (key.startsWith("Packages/"))
        {
            keyIsPackage = true;
        }
		
        // if there's an exact match for the page url, set the data and break
        if (window.trimmedPageName == key)
        {
            debuglog("Exact match found: " + key)
            window.pagearea = feedbackAreas[key].area;
            window.pagetags = feedbackAreas[key].tags;
            break;
        }
        // if there's a partial match
        // and it's longer than the last partial match
        // and the key type matches the page type (i.e. both a package, or both not a package)
        // then we update data with this and keep looking in case there's a better match
        else if (window.trimmedPageName.startsWith(key) && key.length > longestMatchLength && pageIsPackage == keyIsPackage)
        {
            debuglog("Best match so far is " + key)
            window.pagearea = feedbackAreas[key].area;
            window.pagetags = feedbackAreas[key].tags;
            longestMatchLength = key.length;
        }
    }
    
	gotPageDetails = true;
    debuglog("GetPageDetails complete:")
    debuglog("window.pagearea = "+window.pagearea);
    debuglog("window.pagetype = "+window.pagetype);
    debuglog("window.pagetags = "+window.pagetags);
    debuglog("window.trimmedPageName = "+window.trimmedPageName);
    debuglog("window.pageversion = "+window.pageversion);
}

// Feedback Events are statistics sent to Google Analytics
// (This is not where user-submitted text is sent)
function SendFeedbackEvent(feedbacktype,feedbackvalue)
{
    GetPageDetails();

    var eventtype = ( feedbacktype=='rating' ? 'rating-submitted' : 'problem-submitted');

    window.dataLayer = window.dataLayer || [ ];
    window.dataLayer.push({
        'event': eventtype,
        'feedbackType': feedbacktype,
        'ratingValue': feedbackvalue,
        'pageArea': pagearea,
        'pageType': pagetype
    });

    window.problemDescription = feedbacktype;

    debuglog(
        "sent feedback event: \n"+
        "event:"+eventtype+"\n"+
        "feedbacktype:"+feedbacktype+"\n"+
        "feedbackvalue:"+feedbackvalue+"\n"+
        "pagearea:"+pagearea+"\n"+
        "pagetype:"+pagetype+"\n"
    );
    

    document.getElementById('feedback-rating').style.display = 'none';
}

function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}


$(function() {

var scrollToFeedbackBoxHtml = `
<div class="scrollToFeedback">
    <a id="scrollToFeedback">Leave feedback</a>
</div>
`

var feedbackBoxHtml = `
<!-- start of feedback box -->
<hr/>
<link rel="stylesheet" href="/StaticFilesConfig/feedback/css/rating.css"></link>
<div class="feedbackbox" id="feedbackbox">
    <div id="feedback-rating">
        <p>Did you find this page useful? Please give it a rating:</p>
        <div id="feedback-ratecontent" class="c-rating"></div>
    </div>
    <div id="feedback-ratingThanks" style="display:none"><p>Thanks for rating this page!</p></div>
    <div id="feedback-problem"><p><a name="problem">Report a problem on this page</a></p></div>
    <div id="feedback-problemType" style="display:none"><p>What kind of problem would you like to report?
        <ul type="problems">
            <li><a name="needcode" id="feedback-problemneedcode">This page needs code samples</a></li>
            <li><a name="code" id="feedback-problemcode">Code samples do not work</a></li>
            <li><a name="missing" id="feedback-problemmissing">Information is missing</a></li>
            <li><a name="incorrect" id="feedback-problemincorrect">Information is incorrect</a></li>
            <li><a name="unclear" id="feedback-problemunclear">Information is unclear or confusing</a></li>
            <li><a name="language" id="feedback-problemlanguage">There is a spelling/grammar error on this page</a></li>
            <li><a name="other" id="feedback-problemother">Something else</a></li>
        </ul>
    </div>
    <div id="feedback-problemThanks" style="display:none">
        <p>
            Thanks for letting us know! This page has been marked for review based on your feedback.
            <br/><br/>If you have time, you can provide more information to help us fix the problem faster.
            <br/><br/>
            <a id="feedback-problemThanksMoreInfoButton">Provide more information</a>
            <br/>
        </p>
    </div>
    <div id="feedback-problemMoreInfo" style="display:none">
        <p id="feedback-problemNeedCodeForm" style="display:none">You've told us this page needs code samples. If you'd like to help us further, you could provide a code sample, or tell us about what kind of code sample you'd like to see:</p>
        <p id="feedback-problemCodeForm" style="display:none">You've told us there are code samples on this page which don't work. If you know how to fix it, or have something better we could use instead, please let us know:</p>
        <p id="feedback-problemMissingForm" style="display:none">You've told us there is information missing from this page. Please tell us more about what's missing:</p>
        <p id="feedback-problemIncorrectForm" style="display:none">You've told us there is incorrect information on this page. If you know what we should change to make it correct, please tell us:</p>
        <p id="feedback-problemUnclearForm" style="display:none">You've told us this page has unclear or confusing information. Please tell us more about what you found unclear or confusing, or let us know how we could make it clearer:</p>
        <p id="feedback-problemLanguageForm" style="display:none">You've told us there is a spelling or grammar error on this page. Please tell us what's wrong:</p>
        <p id="feedback-problemOtherForm" style="display:none">You've told us this page has a problem. Please tell us more about what's wrong:</p>
        <form>
            <textarea id="feedback-problemFormSuggestionField" cols="40" rows="5"></textarea>
            <input type="submit" id="feedback-problemFormDescriptionSubmit" value="Submit"/>
        </form>
    </div>
    <div id="feedback-problemMoreInfoThanks" style="display:none">
        <p>Thanks for helping to make the Unity documentation better!</p>
    </div>
</div>
<!-- end of feedback box -->
`

    debuglog("feedback:  initialising");

    // include feedback areas definition file:
    if (typeof feedbackAreas === 'undefined')
    {
        $.getScript('/StaticFilesConfig/feedback/feedback-areas.js', function() {});
        
        if (typeof feedbackAreas === 'undefined')
        {
            debuglog("Warning! feedbackAreas still undefined after attempting to getScript");
        } else {
			debuglog("Read feedbackAreas data");
		}
      }


    if (document.getElementById('_content'))
    {
        // classic version
        $('#_content').after(feedbackBoxHtml);

    } else if (document.getElementById('mc-main-content')) {
        // mizu version
        $('#mc-main-content').after(feedbackBoxHtml);

    } else {
        debuglog("Feedback system error: Couldn't find element with correct ID to place feedback after.");
    }

    // include rating controller
    InitialiseRatingController();

    // suggest a problem link (button)
    $('#feedback-problem').click( function(e) {
        $('#feedback-problemType').show();
        $('#feedback-problem').hide();
    });

    // the problem types:
    
    // needs code
    $('#feedback-problemneedcode').click( function(e) {
        $('#feedback-problemType').hide();
        $('#feedback-problemThanks').show();
        window.problemDescription='Needs code samples';
        $('#feedback-problemNeedCodeForm').show();
        SendFeedbackEvent('problem-needcode',0);
    });

    // code (problem in existing code)
    $('#feedback-problemcode').click( function(e) {
        $('#feedback-problemType').hide();
        $('#feedback-problemThanks').show();
        window.problemDescription='Code samples do not work';
        $('#feedback-problemCodeForm').show();
        SendFeedbackEvent('problem-brokencode',0);
    });

    // missing information
    $('#feedback-problemmissing').click( function(e) {
        $('#feedback-problemType').hide();
        $('#feedback-problemThanks').show();
        window.problemDescription='Missing information';
        $('#feedback-problemMissingForm').show();
        SendFeedbackEvent('problem-missing',0);
    });

    // incorrect information
    $('#feedback-problemincorrect').click( function(e) {
        $('#feedback-problemType').hide();
        $('#feedback-problemThanks').show();
        window.problemDescription='Incorrect information';
        $('#feedback-problemIncorrectForm').show();
        SendFeedbackEvent('problem-incorrect',window.location.href,0);
    });


    // unclear
    $('#feedback-problemunclear').click( function(e) {
        $('#feedback-problemType').hide();
        $('#feedback-problemThanks').show();
        window.problemDescription='Unclear or confusing information';
        $('#feedback-problemUnclearForm').show();
        SendFeedbackEvent('problem-unclear',0);
    });


    // spelling or grammar (language)
    $('#feedback-problemlanguage').click( function(e) {
        $('#feedback-problemType').hide();
        $('#feedback-problemThanks').show();
        window.problemDescription='Spelling or grammar error';
        $('#feedback-problemLanguageForm').show();
        SendFeedbackEvent('problem-language',0);
    });

    // other
    $('#feedback-problemother').click( function(e) {
        $('#feedback-problemType').hide();
        window.problemDescription='This page has a problem';
        // clicking "other" is slightly different, it skips the initial "thanks"
        // and takes the user straight to the "more info" text box
        $('#feedback-problemOtherForm').show();
        $('#feedback-problemMoreInfo').show();
        SendFeedbackEvent('problem-other',0);
    });

    // submit more info button
    $('#feedback-problemThanksMoreInfoButton').click( function(e) {
        $('#feedback-problemThanks').hide();
        $('#feedback-problemMoreInfo').show();
    });

    // default text in feedback suggestion field
    $("textarea#problemFormSuggestionField").val('');

    $('.scrollToFeedback').click( function(e) {
        $("html, body").animate({ scrollTop: $(document).height() }, 1000);
        setTimeout(function(){
            $(".feedbackbox").css('background','#ff0');
        },700);
        setTimeout(function(){
            $(".feedbackbox").css('background','#eee');
        },1100);
    });

    $('#feedback-problemFormDescriptionSubmit').click( function(e)
    {
        // stop the form from submitting the normal way and refreshing the page
        e.preventDefault();
        
        
        // get the page area, tags, version etc
        GetPageDetails();
        
        // hide the text entry field and show the thanks text.
        $("#feedback-problemMoreInfo").hide();
        $("#feedback-problemMoreInfoThanks").show();
        
        var submitURL = "https://hooks.zapier.com/hooks/catch/9835634/bgn3jv4/";
        
        var problemDescription = window.problemDescription;
        var page = window.trimmedPageName;
        var url =  window.location.href;
        var version = window.pageversion;
        
        var suggestion = $("textarea#feedback-problemFormSuggestionField").val();
        
        // we ignore empty (or extremely short) submissions and do nothing (but still say thanks!)
        if (suggestion.trim() == "" || suggestion.length < 4) {
            return false;
        }

        var tags = "";
        var areaId = "unknown"; // (mapped to project/team in jira)
        
        // if lookup data from the feedback-areas.js contains valid match, use that data
        if (areaValues[window.pagearea] != null)
        {
            areaId = areaValues[window.pagearea].trackingTag;
            tags = areaId;
        }
        
        if (window.pagetags != "") { tags += ","+window.pagetags; }
        
        var postData = {
            "title":page,
            "description":suggestion,
            "areaId":areaId,
            "tag":tags,
            "version":version,
            "problemType":problemDescription,
            "url":url,
            "docsType":window.pagetype
        };

        debuglog("post data:");
        debuglog(postData);

        var xhr = new XMLHttpRequest();
        xhr.open("POST", submitURL);
        
        xhr.onreadystatechange = function () {
           if (xhr.readyState === 4) {
              debuglog("Status", xhr.status);
              debuglog("Response Text", xhr.responseText);
           }};
        xhr.send(JSON.stringify(postData));

         return false;
    });

    InitialiseStarRating();

    debuglog("feedback: setup done");


});

function debuglog(msg)
{
    if (debug)
    {
        console.log(msg);
    }
}

function InitialiseRatingController() {

  'use strict';


  /**
   * rating
   *
   * @description The rating component.
   * @param {HTMLElement} el The HTMl element to build the rating widget on
   * @param {Number} currentRating The current rating value
   * @param {Number} maxRating The max rating for the widget
   * @param {Function} callback The optional callback to run after set rating
   * @return {Object} Some public methods
   */
  function rating(el, currentRating, maxRating, callback) {

    /**
     * stars
     *
     * @description The collection of stars in the rating.
     * @type {Array}
     */
    var stars = [];

    /**
     * init
     *
     * @description Initializes the rating widget. Returns nothing.
     */
    (function init() {
      if (!el) { throw Error('No element supplied.'); }
      if (!maxRating) { throw Error('No max rating supplied.'); }
      if (!currentRating) { currentRating = 0; }
      if (currentRating < 0 || currentRating > maxRating) { throw Error('Current rating is out of bounds.'); }

      for (var i = 0; i < maxRating; i++) {
        var star = document.createElement('li');
        star.classList.add('c-rating__item');
        star.setAttribute('data-index', i);
        if (i < currentRating) { star.classList.add('is-active'); }
        el.appendChild(star);
        stars.push(star);
        attachStarEvents(star);
      }
    })();

    /**
     * iterate
     *
     * @description A simple iterator used to loop over the stars collection.
     *   Returns nothing.
     * @param {Array} collection The collection to be iterated
     * @param {Function} callback The callback to run on items in the collection
     */
    function iterate(collection, callback) {
      for (var i = 0; i < collection.length; i++) {
        var item = collection[i];
        callback(item, i);
      }
    }

    /**
     * attachStarEvents
     *
     * @description Attaches events to each star in the collection. Returns
     *   nothing.
     * @param {HTMLElement} star The star element
     */
    function attachStarEvents(star) {
      starMouseOver(star);
      starMouseOut(star);
      starClick(star);
    }

    /**
     * starMouseOver
     *
     * @description The mouseover event for the star. Returns nothing.
     * @param {HTMLElement} star The star element
     */
    function starMouseOver(star) {
      star.addEventListener('mouseover', function(e) {
        iterate(stars, function(item, index) {
          if (index <= parseInt(star.getAttribute('data-index'))) {
            item.classList.add('is-active');
          } else {
            item.classList.remove('is-active');
          }
        });
      });
    }

    /**
     * starMouseOut
     *
     * @description The mouseout event for the star. Returns nothing.
     * @param {HTMLElement} star The star element
     */
    function starMouseOut(star) {
      star.addEventListener('mouseout', function(e) {
        if (stars.indexOf(e.relatedTarget) === -1) {
          setRating(null, false);
        }
      });
    }

    /**
     * starClick
     *
     * @description The click event for the star. Returns nothing.
     * @param {HTMLElement} star The star element
     */
    function starClick(star) {
      star.addEventListener('click', function(e) {
        e.preventDefault();
        setRating(parseInt(star.getAttribute('data-index')) + 1, true);
      });
    }

    /**
     * setRating
     *
     * @description Sets and updates the currentRating of the widget, and runs
     *   the callback if supplied. Returns nothing.
     * @param {Number} value The number to set the rating to
     * @param {Boolean} doCallback A boolean to determine whether to run the
     *   callback or not
     */
    function setRating(value, doCallback) {
      if (value && value < 0 || value > maxRating) { return; }
      if (doCallback === undefined) { doCallback = true; }

      currentRating = value || currentRating;

      iterate(stars, function(star, index) {
        if (index < currentRating) {
          star.classList.add('is-active');
        } else {
          star.classList.remove('is-active');
        }
      });

      if (callback && doCallback) { callback(getRating()); }
    }

    /**
     * getRating
     *
     * @description Gets the current rating.
     * @return {Number} The current rating
     */
    function getRating() {
      return currentRating;
    }

    /**
     * Returns the setRating and getRating methods
     */
    return {
      setRating: setRating,
      getRating: getRating
    };

  }

  /**
   * Add to global namespace
   */
  window.rating = rating;

};